<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIç»˜å›¾ä»»åŠ¡ç®¡ç†å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        body.paste-lock {
            cursor: cell !important;
        }

        body.paste-lock::after {
            content: 'ğŸ“‹ è¯·æŒ‰ Ctrl+V ç²˜è´´å›¾ç‰‡';
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(102, 126, 234, 0.95);
            color: white;
            padding: 20px 40px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            z-index: 9999;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header-left p {
            opacity: 0.9;
            font-size: 14px;
        }

        .header-right {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .api-status {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .api-status.connected {
            background: rgba(40, 167, 69, 0.3);
        }

        .api-status.disconnected {
            background: rgba(220, 53, 69, 0.3);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }

        .api-status.disconnected .status-dot {
            background: #dc3545;
        }

        .settings-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .action-buttons {
            display: flex;
            gap: 20px;
            padding: 32px;
            justify-content: center;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .action-btn {
            flex: 1;
            max-width: 400px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 32px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .action-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px rgba(102, 126, 234, 0.5);
        }

        .action-btn:active {
            transform: translateY(-2px);
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .action-btn.secondary:hover {
            box-shadow: 0 12px 28px rgba(245, 87, 108, 0.5);
        }

        .task-list-section {
            padding: 24px;
        }

        .task-list-header {
            margin-bottom: 16px;
        }

        .search-box {
            margin-bottom: 16px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            border-color: #667eea;
            outline: none;
        }

        .stats-bar {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .task-row {
            display: grid;
            grid-template-columns: 120px 80px 140px 1fr 100px 80px 100px;
            gap: 12px;
            align-items: center;
            background: #f8f9fa;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .task-row:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateX(4px);
        }

        .task-row-header {
            display: grid;
            grid-template-columns: 120px 80px 140px 1fr 100px 80px 100px;
            gap: 12px;
            align-items: center;
            padding: 12px 16px;
            background: #667eea;
            color: white;
            font-weight: 600;
            border-radius: 8px;
            font-size: 13px;
        }

        .task-id {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .task-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        .task-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .task-status.completed {
            background: #d4edda;
            color: #155724;
        }

        .task-status.failed {
            background: #f8d7da;
            color: #721c24;
        }

        .task-model {
            color: #666;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .task-prompt-preview {
            color: #333;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .task-time {
            color: #999;
            font-size: 12px;
        }

        .task-action {
            color: #667eea;
            font-size: 13px;
            text-align: center;
            font-weight: 500;
        }

        .image-preview {
            width: 60px;
            height: 60px;
            background: #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            background-size: cover;
            background-position: center;
            border: 2px solid transparent;
        }

        .image-preview:hover {
            transform: scale(1.1);
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .image-preview-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 24px;
        }

        .result-preview-container {
            display: flex;
            gap: 4px;
        }

        .result-preview-mini {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .result-preview-mini:hover {
            transform: scale(1.15);
            border-color: #667eea;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px 16px 0 0;
            color: white;
        }

        .modal-header h2 {
            font-size: 20px;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            color: white;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 24px;
        }

        /* å¤§å›¾é¢„è§ˆæ ·å¼ */
        .image-preview-modal {
            max-width: 90vw;
            max-height: 90vh;
        }

        .image-preview-modal .modal-content {
            background: transparent;
            box-shadow: none;
            max-width: 90vw;
            max-height: 90vh;
        }

        .image-preview-modal .modal-header {
            background: rgba(0, 0, 0, 0.8);
        }

        .image-preview-modal .modal-body {
            padding: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-preview-modal img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group select,
        .form-group textarea,
        .form-group input[type="text"],
        .form-group input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group select:focus,
        .form-group textarea:focus,
        .form-group input:focus {
            border-color: #667eea;
            outline: none;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.4);
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.4);
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }

        .model-info {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .model-info h3 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .model-info p {
            color: #666;
            font-size: 13px;
            line-height: 1.6;
        }

        .file-input-wrapper {
            position: relative;
            margin-bottom: 16px;
        }

        .file-input-wrapper input[type="file"] {
            display: none;
        }

        .paste-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-left: 12px;
        }

        .paste-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .paste-btn:active {
            transform: translateY(0);
        }

        .file-input-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .file-input-header label {
            margin: 0;
            font-weight: 500;
            color: #333;
        }

        .file-input-label {
            display: block;
            padding: 20px;
            border: 2px dashed #667eea;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            color: #667eea;
            font-weight: 500;
            position: relative;
        }

        .file-input-label:hover {
            background: #f8f9fa;
        }

        .file-input-label.dragover {
            background: #e9ecef;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .file-preview {
            margin-top: 12px;
            display: none;
        }

        .file-preview.active {
            display: block;
        }

        .file-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .result-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }

        .result-item:hover {
            transform: scale(1.02);
        }

        .result-item.selected {
            ring: 4px solid #667eea;
            box-shadow: 0 0 0 4px #667eea;
        }

        .result-image {
            width: 100%;
            height: 200px;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 48px;
            position: relative;
            background-size: cover;
            background-position: center;
            cursor: pointer;
        }

        .result-image.has-image {
            cursor: pointer;
        }

        .result-image:hover::after {
            content: 'ğŸ”';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: white;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .result-item.selected .check-mark {
            opacity: 1;
        }

        .check-mark {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 18px;
            z-index: 10;
        }

        .result-prompt {
            padding: 12px;
            font-size: 13px;
            color: #666;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-label {
            color: #666;
            font-size: 13px;
        }

        .stat-value {
            color: #667eea;
            font-weight: 600;
            font-size: 16px;
        }

        .edit-area {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-top: 16px;
        }

        .edit-area h4 {
            color: #667eea;
            margin-bottom: 16px;
            font-size: 16px;
        }

        .edit-buttons {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .edit-buttons button {
            flex: 1;
        }

        .detail-section {
            margin-bottom: 24px;
        }

        .detail-section h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }

        .detail-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .detail-info-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
        }

        .detail-info-label {
            color: #666;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .detail-info-value {
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .detail-image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 12px;
        }

        .detail-image-item {
            position: relative;
        }

        .detail-image-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .detail-image-item img:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .detail-image-label {
            text-align: center;
            color: #666;
            font-size: 13px;
            margin-top: 8px;
        }

        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            background: #f8f9fa;
            border-radius: 8px;
        }

        /* APIè®¾ç½®é¡µé¢æ ·å¼ */
        .api-settings-page {
            padding: 20px;
        }

        .api-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .api-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }

        .api-tab.active {
            color: #667eea;
        }

        .api-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #667eea;
        }

        .api-tab:hover {
            color: #667eea;
        }

        .api-account-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .api-account-item {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .api-account-item:hover {
            border-color: #667eea;
        }

        .api-account-item.default-account {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.05);
        }

        .api-account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .api-account-name {
            font-weight: 600;
            color: #333;
        }

        .api-account-status {
            display: flex;
            gap: 8px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.connected {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.default {
            background: #cce5ff;
            color: #004085;
        }

        .api-account-actions {
            display: flex;
            gap: 8px;
        }

        .api-account-actions button {
            padding: 6px 12px;
            font-size: 12px;
        }

        .api-account-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 6px;
        }

        .api-detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .api-detail-label {
            font-size: 12px;
            color: #666;
        }

        .api-detail-value {
            font-size: 13px;
            color: #333;
            font-weight: 500;
        }

        .api-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .api-form h3 {
            color: #667eea;
            margin-bottom: 16px;
            font-size: 16px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-size: 14px;
        }

        .api-usage-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .usage-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .usage-stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 16px;
            border-radius: 8px;
        }

        .usage-stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 4px;
        }

        .usage-stat-value {
            font-size: 24px;
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
                padding: 20px;
            }

            .action-btn {
                max-width: 100%;
            }

            .task-row,
            .task-row-header {
                grid-template-columns: 80px 60px 100px 1fr 80px;
                gap: 8px;
            }

            .task-row > *,
            .task-row-header > * {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>ğŸ¨ AIç»˜å›¾ä»»åŠ¡ç®¡ç†å¹³å°</h1>
                <p>é›†æˆè±†åŒ…ã€å³æ¢¦ç­‰AIæ¨¡å‹ï¼Œä¸“ä¸šç»˜å›¾ä»»åŠ¡ç®¡ç†</p>
            </div>
            <div class="header-right">
                <div class="api-status disconnected" id="apiStatus">
                    <div class="status-dot"></div>
                    <span id="apiStatusText">æœªé…ç½®API</span>
                </div>
                <button class="settings-btn" onclick="openApiSettings()">âš™ï¸ APIè®¾ç½®</button>
                <button class="settings-btn" onclick="window.open('/admin.html', '_blank')">ğŸ”§ åå°ç®¡ç†</button>
            </div>
        </div>

        <div class="action-buttons">
            <button class="action-btn" onclick="openGenerateModal('text')">
                <span style="font-size: 24px;">ğŸ“</span>
                æ–‡å­—ç”Ÿå›¾
            </button>
            <button class="action-btn secondary" onclick="openGenerateModal('image')">
                <span style="font-size: 24px;">ğŸ–¼ï¸</span>
                å‚è€ƒå›¾ç”Ÿå›¾
            </button>
        </div>

        <div class="task-list-section">
            <div class="task-list-header">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢ä»»åŠ¡ç¼–å·..." oninput="filterTasks()">
                </div>
                <div class="stats-bar">
                    <div class="stat-item">
                        <span class="stat-label">æ€»ä»»åŠ¡ï¼š</span>
                        <span class="stat-value" id="totalTasks">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">å·²å®Œæˆï¼š</span>
                        <span class="stat-value" id="completedTasks">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">å¤„ç†ä¸­ï¼š</span>
                        <span class="stat-value" id="pendingTasks">0</span>
                    </div>
                </div>
            </div>

            <div id="taskListContainer" class="task-list">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“‹</div>
                    <p>æš‚æ— ä»»åŠ¡ï¼Œå¿«å»åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªç»˜å›¾ä»»åŠ¡å§ï¼</p>
                    <p style="font-size: 13px; margin-top: 8px;">æç¤ºï¼šè¯·å…ˆåœ¨å³ä¸Šè§’é…ç½®APIè´¦å·</p>
                </div>
            </div>
        </div>
    </div>

    <!-- APIè®¾ç½®å¼¹çª— -->
    <div class="modal" id="apiSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âš™ï¸ APIè´¦å·ç®¡ç†</h2>
                <button class="close-btn" onclick="closeApiSettings()">&times;</button>
            </div>
            <div class="modal-body" id="apiSettingsBody">
                <!-- åŠ¨æ€å†…å®¹ -->
            </div>
        </div>
    </div>

    <!-- ç”Ÿå›¾å¼¹çª— -->
    <div class="modal" id="generateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="generateModalTitle">ç”Ÿå›¾</h2>
                <button class="close-btn" onclick="closeGenerateModal()">&times;</button>
            </div>
            <div class="modal-body" id="generateModalBody">
                <!-- åŠ¨æ€å†…å®¹ -->
            </div>
        </div>
    </div>

    <!-- ä»»åŠ¡è¯¦æƒ…å¼¹çª— -->
    <div class="modal" id="taskDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ä»»åŠ¡è¯¦æƒ…</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- åŠ¨æ€å†…å®¹ -->
            </div>
        </div>
    </div>

    <!-- å¤§å›¾é¢„è§ˆå¼¹çª— -->
    <div class="modal image-preview-modal" id="imagePreviewModal">
        <div class="modal-content" style="background: transparent; box-shadow: none;">
            <div class="modal-header" style="background: rgba(0, 0, 0, 0.8);">
                <h2 id="imagePreviewTitle">å›¾ç‰‡é¢„è§ˆ</h2>
                <button class="close-btn" onclick="closeImagePreview()">&times;</button>
            </div>
            <div class="modal-body" style="background: rgba(0, 0, 0, 0.9);">
                <img id="imagePreviewImg" src="" alt="å›¾ç‰‡é¢„è§ˆ">
            </div>
        </div>
    </div>

    <script>
        // AIæ¨¡å‹é…ç½®
        const AI_MODELS = {
            doubao: {
                name: 'è±†åŒ…',
                type: 'general',
                provider: 'volcengine',
                description: 'å­—èŠ‚è·³åŠ¨æ¨å‡ºçš„é€šç”¨AIç»˜å›¾æ¨¡å‹ï¼Œæ”¯æŒå¤šç§é£æ ¼',
                apiUrl: 'https://ark.cn-beijing.volces.com/api/v3/chat/completions',
                modelName: 'ep-20241223111111-xxxxx' // ç”¨æˆ·éœ€è¦é…ç½®
            },
            jimeng_dream: {
                name: 'å³æ¢¦-æ¢¦å¢ƒ',
                type: 'creative',
                provider: 'jimeng',
                description: 'ä¸“æ³¨äºåˆ›æ„å’Œæ¢¦å¢ƒé£æ ¼çš„å›¾ç‰‡ç”Ÿæˆ',
                apiUrl: 'https://api.jimeng.jianying.com/prompt/generate',
                modelName: 'dream'
            },
            jimeng_realistic: {
                name: 'å³æ¢¦-å†™å®',
                type: 'realistic',
                provider: 'jimeng',
                description: 'æ“…é•¿ç”Ÿæˆå†™å®é£æ ¼çš„é«˜è´¨é‡å›¾ç‰‡',
                apiUrl: 'https://api.jimeng.jianying.com/prompt/generate',
                modelName: 'realistic'
            },
            jimeng_anime: {
                name: 'å³æ¢¦-åŠ¨æ¼«',
                type: 'anime',
                provider: 'jimeng',
                description: 'ä¸“ä¸šçš„åŠ¨æ¼«é£æ ¼å›¾ç‰‡ç”Ÿæˆæ¨¡å‹',
                apiUrl: 'https://api.jimeng.jianying.com/prompt/generate',
                modelName: 'anime'
            },
            jimeng_style: {
                name: 'å³æ¢¦-é£æ ¼è¿ç§»',
                type: 'style',
                provider: 'jimeng',
                description: 'åŸºäºå‚è€ƒå›¾è¿›è¡Œé£æ ¼è¿ç§»',
                apiUrl: 'https://api.jimeng.jianying.com/style_transfer',
                modelName: 'style_transfer'
            },
            jimeng_enhance: {
                name: 'å³æ¢¦-ç”»è´¨å¢å¼º',
                type: 'enhance',
                provider: 'jimeng',
                description: 'æå‡å‚è€ƒå›¾çš„ç”»è´¨å’Œç»†èŠ‚',
                apiUrl: 'https://api.jimeng.jianying.com/enhance',
                modelName: 'enhance'
            }
        };

        // ä»»åŠ¡å­˜å‚¨
        let tasks = [];
        let currentTaskId = 0;
        let referenceImageData = null;
        let baseImageData = null;
        let textImageData = null;
        let filteredTasks = [];
        let currentPasteArea = null;

        // APIè´¦å·å­˜å‚¨
        let apiAccounts = [];

        // APIåŸºç¡€URL
        const API_BASE_URL = window.location.origin + '/api';

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                // ä»åç«¯APIåŠ è½½ä»»åŠ¡
                const tasksResponse = await fetch(`${API_BASE_URL}/tasks`);
                const tasksData = await tasksResponse.json();
                if (tasksData.success) {
                    tasks = tasksData.tasks;
                    currentTaskId = tasks.length;
                }

                // ä»åç«¯APIåŠ è½½è´¦å·
                const accountsResponse = await fetch(`${API_BASE_URL}/accounts`);
                const accountsData = await accountsResponse.json();
                if (accountsData.success) {
                    apiAccounts = accountsData.accounts;
                }
            } catch (e) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', e);
                // å¦‚æœAPIä¸å¯ç”¨ï¼Œå°è¯•ä»localStorageåŠ è½½
                const savedTasks = localStorage.getItem('aiDrawTasks');
                if (savedTasks) {
                    tasks = JSON.parse(savedTasks);
                    currentTaskId = tasks.length;
                }

                const savedAccounts = localStorage.getItem('apiAccounts');
                if (savedAccounts) {
                    apiAccounts = JSON.parse(savedAccounts);
                }
            }
        }

        // ç”Ÿæˆä»»åŠ¡ID
        function generateTaskId() {
            return `TASK-${String(++currentTaskId).padStart(6, '0')}`;
        }

        // è·å–å½“å‰æ—¶é—´
        function getCurrentTime() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        }

        // æ›´æ–°APIçŠ¶æ€æ˜¾ç¤º
        function updateApiStatus() {
            const status = document.getElementById('apiStatus');
            const statusText = document.getElementById('apiStatusText');

            const defaultAccount = apiAccounts.find(acc => acc.isDefault);
            if (defaultAccount) {
                status.classList.remove('disconnected');
                status.classList.add('connected');
                statusText.textContent = `å·²è¿æ¥: ${defaultAccount.name}`;
            } else {
                status.classList.remove('connected');
                status.classList.add('disconnected');
                statusText.textContent = 'æœªé…ç½®API';
            }
        }

        // æ‰“å¼€APIè®¾ç½®å¼¹çª—
        function openApiSettings() {
            const modal = document.getElementById('apiSettingsModal');
            const body = document.getElementById('apiSettingsBody');
            
            body.innerHTML = getApiSettingsContent();
            modal.classList.add('active');
        }

        // å…³é—­APIè®¾ç½®å¼¹çª—
        function closeApiSettings() {
            document.getElementById('apiSettingsModal').classList.remove('active');
        }

        // è·å–APIè®¾ç½®å†…å®¹
        function getApiSettingsContent() {
            return `
                <div class="api-tabs">
                    <button class="api-tab active" onclick="switchApiTab('accounts')">è´¦å·ç®¡ç†</button>
                    <button class="api-tab" onclick="switchApiTab('add')">æ·»åŠ è´¦å·</button>
                    <button class="api-tab" onclick="switchApiTab('stats')">ä½¿ç”¨ç»Ÿè®¡</button>
                </div>

                <div id="apiAccountsPanel">
                    <div class="api-account-list">
                        ${apiAccounts.length === 0 ? `
                            <div class="empty-state" style="padding: 40px;">
                                <div class="empty-state-icon">ğŸ”‘</div>
                                <p>æš‚æ— APIè´¦å·ï¼Œè¯·æ·»åŠ è´¦å·åå¼€å§‹ä½¿ç”¨</p>
                            </div>
                        ` : apiAccounts.map(account => `
                            <div class="api-account-item ${account.isDefault ? 'default-account' : ''}">
                                <div class="api-account-header">
                                    <div class="api-account-name">
                                        ${account.name}
                                        ${account.isDefault ? '<span class="status-badge default">é»˜è®¤</span>' : ''}
                                    </div>
                                    <div class="api-account-status">
                                        <span class="status-badge connected">å·²é…ç½®</span>
                                    </div>
                                </div>
                                <div class="api-account-details">
                                    <div class="api-detail-item">
                                        <span class="api-detail-label">æœåŠ¡æä¾›å•†</span>
                                        <span class="api-detail-value">${account.provider}</span>
                                    </div>
                                    <div class="api-detail-item">
                                        <span class="api-detail-label">APIå¯†é’¥</span>
                                        <span class="api-detail-value">${maskApiKey(account.apiKey)}</span>
                                    </div>
                                    <div class="api-detail-item">
                                        <span class="api-detail-label">ä½¿ç”¨æ¬¡æ•°</span>
                                        <span class="api-detail-value">${account.usageCount || 0}</span>
                                    </div>
                                </div>
                                <div class="api-account-actions" style="margin-top: 12px;">
                                    <button class="btn btn-secondary" onclick="editAccount('${account.id}')">ç¼–è¾‘</button>
                                    ${!account.isDefault ? `<button class="btn btn-success" onclick="setDefaultAccount('${account.id}')">è®¾ä¸ºé»˜è®¤</button>` : ''}
                                    <button class="btn btn-danger" onclick="deleteAccount('${account.id}')">åˆ é™¤</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div id="apiAddPanel" style="display: none;">
                    <div class="api-form">
                        <h3>ğŸ”‘ æ·»åŠ APIè´¦å·</h3>
                        <div class="form-group">
                            <label>è´¦å·åç§°</label>
                            <input type="text" id="accountName" placeholder="ä¾‹å¦‚ï¼šä¸»è´¦å·ã€æµ‹è¯•è´¦å·">
                        </div>
                        <div class="form-group">
                            <label>æœåŠ¡æä¾›å•†</label>
                            <select id="accountProvider">
                                <option value="volcengine">ç«å±±å¼•æ“ï¼ˆè±†åŒ…ï¼‰</option>
                                <option value="jimeng">å³æ¢¦ï¼ˆå‰ªæ˜ ï¼‰</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>APIå¯†é’¥</label>
                            <input type="password" id="accountApiKey" placeholder="è¾“å…¥æ‚¨çš„APIå¯†é’¥">
                        </div>
                        <div class="form-group">
                            <label>API Endpointï¼ˆé€‰å¡«ï¼‰</label>
                            <input type="text" id="accountEndpoint" placeholder="https://api.example.com/v1">
                        </div>
                        <div class="form-group">
                            <label>æ¨¡å‹IDï¼ˆé€‰å¡«ï¼‰</label>
                            <input type="text" id="accountModelId" placeholder="ä¾‹å¦‚ï¼šep-20241223111111-xxxxx">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="isDefaultAccount">
                            <label for="isDefaultAccount">è®¾ä¸ºé»˜è®¤è´¦å·</label>
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="btn" onclick="saveAccount()">ä¿å­˜è´¦å·</button>
                        </div>
                    </div>
                </div>

                <div id="apiStatsPanel" style="display: none;">
                    <div class="api-usage-stats">
                        <h3>ğŸ“Š APIä½¿ç”¨ç»Ÿè®¡</h3>
                        <div class="usage-stats-grid">
                            <div class="usage-stat-item">
                                <div class="usage-stat-label">æ€»è°ƒç”¨æ¬¡æ•°</div>
                                <div class="usage-stat-value">${apiAccounts.reduce((sum, acc) => sum + (acc.usageCount || 0), 0)}</div>
                            </div>
                            <div class="usage-stat-item">
                                <div class="usage-stat-label">æˆåŠŸæ¬¡æ•°</div>
                                <div class="usage-stat-value">${apiAccounts.reduce((sum, acc) => sum + (acc.successCount || 0), 0)}</div>
                            </div>
                            <div class="usage-stat-item">
                                <div class="usage-stat-label">å¤±è´¥æ¬¡æ•°</div>
                                <div class="usage-stat-value">${apiAccounts.reduce((sum, acc) => sum + (acc.failureCount || 0), 0)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // åˆ‡æ¢APIæ ‡ç­¾é¡µ
        function switchApiTab(tab) {
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.api-tab').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');

            // æ˜¾ç¤ºå¯¹åº”é¢æ¿
            document.getElementById('apiAccountsPanel').style.display = 'none';
            document.getElementById('apiAddPanel').style.display = 'none';
            document.getElementById('apiStatsPanel').style.display = 'none';

            if (tab === 'accounts') {
                document.getElementById('apiAccountsPanel').style.display = 'block';
            } else if (tab === 'add') {
                document.getElementById('apiAddPanel').style.display = 'block';
            } else if (tab === 'stats') {
                document.getElementById('apiStatsPanel').style.display = 'block';
            }
        }

        // é®è”½APIå¯†é’¥
        function maskApiKey(key) {
            if (!key || key.length <= 8) return '****';
            return key.substring(0, 4) + '****' + key.substring(key.length - 4);
        }

        // ä¿å­˜è´¦å·
        function saveAccount() {
            const name = document.getElementById('accountName').value.trim();
            const provider = document.getElementById('accountProvider').value;
            const apiKey = document.getElementById('accountApiKey').value.trim();
            const endpoint = document.getElementById('accountEndpoint').value.trim();
            const modelId = document.getElementById('accountModelId').value.trim();
            const isDefault = document.getElementById('isDefaultAccount').checked;

            if (!name || !apiKey) {
                alert('è¯·å¡«å†™è´¦å·åç§°å’ŒAPIå¯†é’¥');
                return;
            }

            const account = {
                id: 'acc_' + Date.now(),
                name,
                provider,
                apiKey,
                endpoint: endpoint || '',
                modelId: modelId || '',
                isDefault,
                usageCount: 0,
                successCount: 0,
                failureCount: 0,
                createdAt: getCurrentTime()
            };

            // å¦‚æœè®¾ä¸ºé»˜è®¤ï¼Œå–æ¶ˆå…¶ä»–è´¦å·çš„é»˜è®¤çŠ¶æ€
            if (isDefault) {
                apiAccounts.forEach(acc => acc.isDefault = false);
            }

            apiAccounts.push(account);
            saveData();

            // åˆ·æ–°ç•Œé¢
            openApiSettings();
            updateApiStatus();

            alert('è´¦å·ä¿å­˜æˆåŠŸï¼');
        }

        // ç¼–è¾‘è´¦å·
        function editAccount(accountId) {
            const account = apiAccounts.find(acc => acc.id === accountId);
            if (!account) return;

            document.getElementById('accountName').value = account.name;
            document.getElementById('accountProvider').value = account.provider;
            document.getElementById('accountApiKey').value = account.apiKey;
            document.getElementById('accountEndpoint').value = account.endpoint || '';
            document.getElementById('accountModelId').value = account.modelId || '';
            document.getElementById('isDefaultAccount').checked = account.isDefault;

            // åˆ‡æ¢åˆ°æ·»åŠ é¡µé¢å¹¶ä¿®æ”¹æ ‡é¢˜
            document.querySelectorAll('.api-tab').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.api-tab')[1].classList.add('active');
            
            document.getElementById('apiAccountsPanel').style.display = 'none';
            document.getElementById('apiAddPanel').style.display = 'block';
            document.getElementById('apiStatsPanel').style.display = 'none';

            // ä¸´æ—¶ä¿å­˜ç¼–è¾‘çš„è´¦å·ID
            window.editingAccountId = accountId;
        }

        // è®¾ä¸ºé»˜è®¤è´¦å·
        function setDefaultAccount(accountId) {
            apiAccounts.forEach(acc => {
                acc.isDefault = (acc.id === accountId);
            });
            saveData();
            openApiSettings();
            updateApiStatus();
        }

        // åˆ é™¤è´¦å·
        function deleteAccount(accountId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤è´¦å·å—ï¼Ÿ')) {
                apiAccounts = apiAccounts.filter(acc => acc.id !== accountId);
                saveData();
                openApiSettings();
                updateApiStatus();
            }
        }

        // è·å–é»˜è®¤APIè´¦å·
        function getDefaultAccount() {
            return apiAccounts.find(acc => acc.isDefault) || apiAccounts[0];
        }

        // APIè°ƒç”¨æ ¸å¿ƒå‡½æ•°
        async function callAI_API(modelType, prompt, referenceImage, baseImage, refStyleImage, count) {
            const account = getDefaultAccount();
            if (!account) {
                throw new Error('è¯·å…ˆé…ç½®APIè´¦å·');
            }

            account.usageCount = (account.usageCount || 0) + 1;
            saveData();

            try {
                let response;
                
                if (account.provider === 'volcengine') {
                    response = await callVolcengineAPI(account, modelType, prompt, referenceImage, count);
                } else if (account.provider === 'jimeng') {
                    response = await callJimengAPI(account, modelType, prompt, baseImage, refStyleImage, count);
                } else {
                    throw new Error('ä¸æ”¯æŒçš„æœåŠ¡æä¾›å•†');
                }

                account.successCount = (account.successCount || 0) + 1;
                saveData();

                return response;
            } catch (error) {
                account.failureCount = (account.failureCount || 0) + 1;
                saveData();
                throw error;
            }
        }

        // è°ƒç”¨ç«å±±å¼•æ“APIï¼ˆè±†åŒ…ï¼‰
        async function callVolcengineAPI(account, modelType, prompt, referenceImage, count) {
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${account.apiKey}`
            };

            const endpoint = account.endpoint || 'https://ark.cn-beijing.volces.com/api/v3/chat/completions';
            const modelId = account.modelId || 'ep-20241223111111-xxxxx';

            const messages = [
                {
                    role: 'user',
                    content: []
                }
            ];

            // æ·»åŠ æ–‡æœ¬æç¤º
            messages[0].content.push({
                type: 'text',
                text: prompt
            });

            // æ·»åŠ å‚è€ƒå›¾ç‰‡
            if (referenceImage) {
                messages[0].content.push({
                    type: 'image_url',
                    image_url: {
                        url: referenceImage
                    }
                });
            }

            const requestBody = {
                model: modelId,
                messages: messages,
                stream: false
            };

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`APIè°ƒç”¨å¤±è´¥: ${errorData.error?.message || response.statusText}`);
            }

            const data = await response.json();
            
            // è§£æè¿”å›çš„å›¾ç‰‡
            const images = [];
            if (data.choices && data.choices[0]?.message?.content) {
                // å‡è®¾è¿”å›çš„æ˜¯base64å›¾ç‰‡æ•°æ®
                const content = data.choices[0].message.content;
                if (typeof content === 'string' && content.startsWith('data:image')) {
                    images.push(content);
                }
            }

            return {
                success: true,
                images: images
            };
        }

        // è°ƒç”¨å³æ¢¦API
        async function callJimengAPI(account, modelType, prompt, baseImage, refStyleImage, count) {
            // å³æ¢¦APIçš„å…·ä½“å®ç°
            // è¿™é‡Œæä¾›åŸºæœ¬æ¡†æ¶ï¼Œéœ€è¦æ ¹æ®å®é™…APIæ–‡æ¡£è°ƒæ•´
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${account.apiKey}`
            };

            const endpoint = account.endpoint || 'https://api.jimeng.jianying.com/prompt/generate';

            const requestBody = {
                prompt: prompt,
                model_name: modelType,
                count: count
            };

            // æ·»åŠ å›¾ç‰‡å‚æ•°
            if (baseImage) {
                requestBody.base_image = baseImage;
            }
            if (refStyleImage) {
                requestBody.reference_image = refStyleImage;
            }

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`å³æ¢¦APIè°ƒç”¨å¤±è´¥: ${errorData.error?.message || response.statusText}`);
            }

            const data = await response.json();
            
            // è§£æè¿”å›çš„å›¾ç‰‡
            const images = data.images || [];

            return {
                success: true,
                images: images
            };
        }

        // æ‰“å¼€ç”Ÿå›¾å¼¹çª—
        function openGenerateModal(type) {
            const account = getDefaultAccount();
            if (!account) {
                alert('è¯·å…ˆé…ç½®APIè´¦å·æ‰èƒ½ä½¿ç”¨ç»˜å›¾åŠŸèƒ½');
                openApiSettings();
                return;
            }

            const modal = document.getElementById('generateModal');
            const title = document.getElementById('generateModalTitle');
            const body = document.getElementById('generateModalBody');

            if (type === 'text') {
                title.textContent = 'ğŸ“ æ–‡å­—ç”Ÿå›¾';
                body.innerHTML = getTextToImageForm();
            } else {
                title.textContent = 'ğŸ–¼ï¸ å‚è€ƒå›¾ç”Ÿå›¾';
                body.innerHTML = getImageToImageForm();
            }

            modal.classList.add('active');

            // åˆå§‹åŒ–æ–°å¼¹çª—çš„æ‹–æ‹½å’Œç²˜è´´åŠŸèƒ½
            setTimeout(() => {
                if (type === 'text') {
                    setupDropZone(document.getElementById('textImageDropZone'), 'text');
                } else {
                    setupDropZone(document.getElementById('baseImageDropZone'), 'base');
                    setupDropZone(document.getElementById('refImageDropZone'), 'ref');
                }
            }, 100);
        }

        // å…³é—­ç”Ÿå›¾å¼¹çª—
        function closeGenerateModal() {
            document.getElementById('generateModal').classList.remove('active');
            // æ¸…ç†æ•°æ®
            textImageData = null;
            baseImageData = null;
            referenceImageData = null;
            currentPasteArea = null;
        }

        // è·å–æ–‡å­—ç”Ÿå›¾è¡¨å•
        function getTextToImageForm() {
            const account = getDefaultAccount();
            const availableModels = Object.keys(AI_MODELS).filter(key => 
                AI_MODELS[key].provider === account.provider || key.startsWith(account.provider)
            );

            return `
                <div class="model-info">
                    <h3>ğŸ“ æ–‡å­—ç”Ÿå›¾æ¨¡å¼</h3>
                    <p>åŸºäºAIæ¨¡å‹ï¼Œé…åˆæ–‡å­—æè¿°å’Œå¯é€‰å‚è€ƒå›¾ç‰‡ç”Ÿæˆç²¾ç¾å›¾ç‰‡ã€‚å½“å‰ä½¿ç”¨: ${account.name}</p>
                </div>

                <div class="form-group">
                    <label>é€‰æ‹©AIæ¨¡å‹</label>
                    <select id="textModelSelect">
                        ${availableModels.map(key => `
                            <option value="${key}">${AI_MODELS[key].name} - ${AI_MODELS[key].description}</option>
                        `).join('')}
                    </select>
                </div>

                <div class="form-group">
                    <div class="file-input-header">
                        <label>ä¸Šä¼ åŸºç¡€å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
                        <button class="paste-btn" onclick="focusPasteArea('text')">ğŸ“‹ ç²˜è´´å›¾ç‰‡</button>
                    </div>
                    <div class="file-input-wrapper" id="textImageDropZone">
                        <input type="file" id="textImageInput" accept="image/*" onchange="handleTextFileSelect(event)">
                        <label for="textImageInput" class="file-input-label">
                            ğŸ“ ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ / æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„
                        </label>
                    </div>
                    <div class="file-preview" id="textImagePreview">
                        <img id="textPreviewImg" src="" alt="é¢„è§ˆå›¾">
                        <button class="btn btn-secondary" style="margin-top: 8px; padding: 8px 16px; font-size: 14px;" onclick="clearTextImage()">æ¸…é™¤å›¾ç‰‡</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>è¯æœ¯æè¿°</label>
                    <textarea id="textPrompt" placeholder="è¯·è¾“å…¥è¯¦ç»†çš„ç”»é¢æè¿°ï¼Œä¾‹å¦‚ï¼šä¸€ä½ç©¿ç€ç™½è‰²è¿è¡£è£™çš„å°‘å¥³ç«™åœ¨èŠ±æµ·ä¸­ï¼Œé˜³å…‰æ¸©æš–ï¼Œç”»é¢å”¯ç¾..."></textarea>
                </div>

                <div class="form-group">
                    <label>ç”Ÿæˆæ•°é‡</label>
                    <select id="textCount">
                        <option value="1">1å¼ </option>
                        <option value="2">2å¼ </option>
                        <option value="4" selected>4å¼ </option>
                        <option value="8">8å¼ </option>
                    </select>
                </div>

                <button class="btn" onclick="generateFromText()">å¼€å§‹ç”Ÿæˆ</button>
            `;
        }

        // è·å–å‚è€ƒå›¾ç”Ÿå›¾è¡¨å•
        function getImageToImageForm() {
            const account = getDefaultAccount();
            const availableModels = Object.keys(AI_MODELS).filter(key => 
                AI_MODELS[key].provider === account.provider || key.startsWith(account.provider)
            );

            return `
                <div class="model-info">
                    <h3>ğŸ–¼ï¸ å‚è€ƒå›¾ç”Ÿå›¾æ¨¡å¼</h3>
                    <p>ä¸Šä¼ åŸºç¡€å›¾ç‰‡å’Œå‚è€ƒé£æ ¼å›¾ï¼ŒAIå°†æ ¹æ®å‚è€ƒå›¾çš„åœºæ™¯æ ·å¼ï¼Œå°†åŸºç¡€å›¾ç‰‡è½¬æ¢ä¸ºå¯¹åº”çš„é£æ ¼æ•ˆæœã€‚å½“å‰ä½¿ç”¨: ${account.name}</p>
                </div>

                <div class="form-group">
                    <label>é€‰æ‹©AIæ¨¡å‹</label>
                    <select id="imageModelSelect">
                        ${availableModels.map(key => `
                            <option value="${key}">${AI_MODELS[key].name} - ${AI_MODELS[key].description}</option>
                        `).join('')}
                    </select>
                </div>

                <div class="form-group">
                    <div class="file-input-header">
                        <label>ä¸Šä¼ åŸºç¡€å›¾ç‰‡</label>
                        <button class="paste-btn" onclick="focusPasteArea('base')">ğŸ“‹ ç²˜è´´å›¾ç‰‡</button>
                    </div>
                    <div class="file-input-wrapper" id="baseImageDropZone">
                        <input type="file" id="baseImageInput" accept="image/*" onchange="handleBaseFileSelect(event)">
                        <label for="baseImageInput" class="file-input-label">
                            ğŸ“ ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ / æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„
                        </label>
                    </div>
                    <div class="file-preview" id="baseImagePreview">
                        <img id="basePreviewImg" src="" alt="é¢„è§ˆå›¾">
                        <button class="btn btn-secondary" style="margin-top: 8px; padding: 8px 16px; font-size: 14px;" onclick="clearBaseImage()">æ¸…é™¤å›¾ç‰‡</button>
                    </div>
                </div>

                <div class="form-group">
                    <div class="file-input-header">
                        <label>ä¸Šä¼ å‚è€ƒé£æ ¼å›¾</label>
                        <button class="paste-btn" onclick="focusPasteArea('ref')">ğŸ“‹ ç²˜è´´å›¾ç‰‡</button>
                    </div>
                    <div class="file-input-wrapper" id="refImageDropZone">
                        <input type="file" id="refImageInput" accept="image/*" onchange="handleRefFileSelect(event)">
                        <label for="refImageInput" class="file-input-label">
                            ğŸ“ ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ / æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„
                        </label>
                    </div>
                    <div class="file-preview" id="refImagePreview">
                        <img id="refPreviewImg" src="" alt="é¢„è§ˆå›¾">
                        <button class="btn btn-secondary" style="margin-top: 8px; padding: 8px 16px; font-size: 14px;" onclick="clearRefImage()">æ¸…é™¤å›¾ç‰‡</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>è¡¥å……æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea id="imagePrompt" placeholder="å¯ä»¥è¡¥å……å¯¹ç”Ÿæˆç”»é¢çš„å…·ä½“è¦æ±‚ï¼Œå¦‚è°ƒæ•´é£æ ¼å¼ºåº¦ã€æ·»åŠ å…ƒç´ ç­‰..."></textarea>
                </div>

                <div class="form-group">
                    <label>ç”Ÿæˆæ•°é‡</label>
                    <select id="imageCount">
                        <option value="1">1å¼ </option>
                        <option value="2">2å¼ </option>
                        <option value="4" selected>4å¼ </option>
                    </select>
                </div>

                <button class="btn" onclick="generateFromImage()">å¼€å§‹ç”Ÿæˆ</button>
            `;
        }

        // èšç„¦ç²˜è´´åŒºåŸŸ
        function focusPasteArea(type) {
            currentPasteArea = type;
            document.body.classList.add('paste-lock');
        }

        // è®¾ç½®æ‹–æ‹½åŒºåŸŸ
        function setupDropZone(dropZone, type) {
            if (!dropZone) return;

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.querySelector('.file-input-label').classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.querySelector('.file-input-label').classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.querySelector('.file-input-label').classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    handleImageFile(files[0], type);
                    // è§£é™¤ç²˜è´´é”å®š
                    document.body.classList.remove('paste-lock');
                    currentPasteArea = null;
                }
            });
        }

        // å¤„ç†å›¾ç‰‡æ–‡ä»¶
        function handleImageFile(file, type) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;

                if (type === 'text') {
                    textImageData = imageData;
                    const preview = document.getElementById('textImagePreview');
                    const img = document.getElementById('textPreviewImg');
                    img.src = imageData;
                    preview.classList.add('active');
                } else if (type === 'base') {
                    baseImageData = imageData;
                    const preview = document.getElementById('baseImagePreview');
                    const img = document.getElementById('basePreviewImg');
                    img.src = imageData;
                    preview.classList.add('active');
                } else if (type === 'ref') {
                    referenceImageData = imageData;
                    const preview = document.getElementById('refImagePreview');
                    const img = document.getElementById('refPreviewImg');
                    img.src = imageData;
                    preview.classList.add('active');
                }

                // è§£é™¤ç²˜è´´é”å®š
                document.body.classList.remove('paste-lock');
                currentPasteArea = null;
            };
            reader.readAsDataURL(file);
        }

        // æ–‡å­—ç”Ÿå›¾æ–‡ä»¶é€‰æ‹©
        function handleTextFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleImageFile(file, 'text');
            }
        }

        // åŸºç¡€å›¾ç‰‡æ–‡ä»¶é€‰æ‹©
        function handleBaseFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleImageFile(file, 'base');
            }
        }

        // å‚è€ƒå›¾ç‰‡æ–‡ä»¶é€‰æ‹©
        function handleRefFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleImageFile(file, 'ref');
            }
        }

        // æ¸…é™¤æ–‡å­—ç”Ÿå›¾å›¾ç‰‡
        function clearTextImage() {
            textImageData = null;
            const preview = document.getElementById('textImagePreview');
            const input = document.getElementById('textImageInput');
            preview.classList.remove('active');
            input.value = '';
        }

        // æ¸…é™¤åŸºç¡€å›¾ç‰‡
        function clearBaseImage() {
            baseImageData = null;
            const preview = document.getElementById('baseImagePreview');
            const input = document.getElementById('baseImageInput');
            preview.classList.remove('active');
            input.value = '';
        }

        // æ¸…é™¤å‚è€ƒå›¾ç‰‡
        function clearRefImage() {
            referenceImageData = null;
            const preview = document.getElementById('refImagePreview');
            const input = document.getElementById('refImageInput');
            preview.classList.remove('active');
            input.value = '';
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            filteredTasks = tasks;
            renderTaskList();
            updateApiStatus();

            // å…¨å±€ç²˜è´´äº‹ä»¶ç›‘å¬
            document.addEventListener('paste', handlePaste);

            // ç‚¹å‡»ä»»æ„åŒºåŸŸè§£é™¤ç²˜è´´é”å®š
            document.addEventListener('click', (e) => {
                // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯ç²˜è´´æŒ‰é’®ï¼Œåˆ™è§£é™¤é”å®š
                if (!e.target.classList.contains('paste-btn') && currentPasteArea) {
                    document.body.classList.remove('paste-lock');
                    currentPasteArea = null;
                }
            });
        });

        // å¤„ç†ç²˜è´´äº‹ä»¶
        function handlePaste(e) {
            const items = e.clipboardData.items;

            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();

                    // ä½¿ç”¨å½“å‰èšç„¦çš„ç²˜è´´åŒºåŸŸï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤é€»è¾‘
                    let type = currentPasteArea;
                    if (!type) {
                        // æ£€æŸ¥å“ªä¸ªå¼¹çª—æ˜¯æ‰“å¼€çš„
                        const generateModal = document.getElementById('generateModal');
                        if (generateModal.classList.contains('active')) {
                            // ç”Ÿå›¾å¼¹çª—æ‰“å¼€ï¼Œåˆ¤æ–­æ˜¯å“ªä¸ªè¡¨å•
                            const title = document.getElementById('generateModalTitle').textContent;
                            if (title.includes('æ–‡å­—ç”Ÿå›¾')) {
                                type = 'text';
                            } else if (title.includes('å‚è€ƒå›¾ç”Ÿå›¾')) {
                                // åœ¨å‚è€ƒå›¾ç”Ÿå›¾æ¨¡å¼ä¸‹ï¼Œä¼˜å…ˆåˆ¤æ–­åŸºç¡€å›¾ç‰‡åŒºåŸŸ
                                const basePreview = document.getElementById('baseImagePreview');
                                const refPreview = document.getElementById('refImagePreview');

                                if (basePreview && basePreview.classList.contains('active')) {
                                    type = 'ref'; // åŸºç¡€å›¾å·²æœ‰ï¼Œç²˜è´´åˆ°å‚è€ƒå›¾
                                } else {
                                    type = 'base'; // åŸºç¡€å›¾æ²¡æœ‰ï¼Œç²˜è´´åˆ°åŸºç¡€å›¾
                                }
                            }
                        }
                    }

                    if (type) {
                        handleImageFile(blob, type);
                        e.preventDefault();
                    }
                    break;
                }
            }
        }

        // æ–‡å­—ç”Ÿå›¾
        async function generateFromText() {
            const model = document.getElementById('textModelSelect').value;
            const prompt = document.getElementById('textPrompt').value.trim();
            const count = parseInt(document.getElementById('textCount').value);

            if (!prompt) {
                alert('è¯·è¾“å…¥è¯æœ¯æè¿°');
                return;
            }

            const taskId = generateTaskId();
            const task = {
                id: taskId,
                type: 'textToImage',
                model: AI_MODELS[model].name,
                modelCode: model,
                prompt: prompt,
                count: count,
                referenceImage: textImageData,
                baseImage: null,
                refStyleImage: null,
                status: 'pending',
                results: [],
                createdAt: getCurrentTime(),
                updatedAt: getCurrentTime()
            };

            tasks.unshift(task);
            saveData();
            renderTaskList();
            closeGenerateModal();

            try {
                // è°ƒç”¨API
                const response = await callAI_API(model, prompt, textImageData, null, null, count);
                
                // æ›´æ–°ä»»åŠ¡çŠ¶æ€
                task.status = 'completed';
                task.results = response.images || [];
                task.updatedAt = getCurrentTime();
                task.errorMessage = '';
                
                saveData();
                renderTaskList();
                
                alert('å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼');
                openTaskDetail(taskId);

            } catch (error) {
                // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤±è´¥
                task.status = 'failed';
                task.errorMessage = error.message;
                task.updatedAt = getCurrentTime();
                
                saveData();
                renderTaskList();
                
                alert(`ç”Ÿæˆå¤±è´¥: ${error.message}`);
            }
        }

        // å‚è€ƒå›¾ç”Ÿå›¾
        async function generateFromImage() {
            const model = document.getElementById('imageModelSelect').value;
            const prompt = document.getElementById('imagePrompt').value.trim();
            const count = parseInt(document.getElementById('imageCount').value);

            if (!baseImageData) {
                alert('è¯·ä¸Šä¼ åŸºç¡€å›¾ç‰‡');
                return;
            }

            if (!referenceImageData) {
                alert('è¯·ä¸Šä¼ å‚è€ƒé£æ ¼å›¾');
                return;
            }

            const taskId = generateTaskId();
            const task = {
                id: taskId,
                type: 'imageToImage',
                model: AI_MODELS[model].name,
                modelCode: model,
                prompt: prompt || 'åŸºäºå‚è€ƒé£æ ¼ç”Ÿæˆ',
                count: count,
                referenceImage: null,
                baseImage: baseImageData,
                refStyleImage: referenceImageData,
                status: 'pending',
                results: [],
                createdAt: getCurrentTime(),
                updatedAt: getCurrentTime()
            };

            tasks.unshift(task);
            saveData();
            renderTaskList();
            closeGenerateModal();

            try {
                // è°ƒç”¨API
                const response = await callAI_API(model, prompt, null, baseImageData, referenceImageData, count);
                
                // æ›´æ–°ä»»åŠ¡çŠ¶æ€
                task.status = 'completed';
                task.results = response.images || [];
                task.updatedAt = getCurrentTime();
                task.errorMessage = '';
                
                saveData();
                renderTaskList();
                
                alert('å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼');
                openTaskDetail(taskId);

            } catch (error) {
                // æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤±è´¥
                task.status = 'failed';
                task.errorMessage = error.message;
                task.updatedAt = getCurrentTime();
                
                saveData();
                renderTaskList();
                
                alert(`ç”Ÿæˆå¤±è´¥: ${error.message}`);
            }
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTaskList() {
            const container = document.getElementById('taskListContainer');
            const searchQuery = document.getElementById('searchInput').value.trim().toLowerCase();

            // è¿‡æ»¤ä»»åŠ¡
            filteredTasks = tasks.filter(task => 
                task.id.toLowerCase().includes(searchQuery)
            );

            // æ›´æ–°ç»Ÿè®¡
            updateStats();

            if (filteredTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <p>æš‚æ— ä»»åŠ¡ï¼Œå¿«å»åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªç»˜å›¾ä»»åŠ¡å§ï¼</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="task-row-header">
                    <div>ä»»åŠ¡ID</div>
                    <div>çŠ¶æ€</div>
                    <div>æ¨¡å‹</div>
                    <div>æç¤ºè¯</div>
                    <div>é¢„è§ˆ</div>
                    <div>æ—¶é—´</div>
                    <div>æ“ä½œ</div>
                </div>
            `;

            filteredTasks.forEach(task => {
                const statusClass = task.status === 'completed' ? 'completed' : 
                                   task.status === 'pending' ? 'pending' : 'failed';
                const statusText = task.status === 'completed' ? 'å·²å®Œæˆ' : 
                                  task.status === 'pending' ? 'å¤„ç†ä¸­' : 'å¤±è´¥';

                // ç”Ÿæˆå›¾ç‰‡é¢„è§ˆ
                let imagePreviews = '';
                if (task.baseImage) {
                    imagePreviews += `<div class="image-preview" style="background-image: url('${task.baseImage}');" onclick="viewImage('${task.baseImage}'); event.stopPropagation();"></div>`;
                } else if (task.referenceImage) {
                    imagePreviews += `<div class="image-preview" style="background-image: url('${task.referenceImage}');" onclick="viewImage('${task.referenceImage}'); event.stopPropagation();"></div>`;
                } else {
                    imagePreviews += `<div class="image-preview image-preview-placeholder">ğŸ“·</div>`;
                }

                // ç»“æœé¢„è§ˆ
                let resultPreviews = '';
                if (task.results && task.results.length > 0) {
                    resultPreviews = '<div class="result-preview-container">';
                    task.results.slice(0, 3).forEach((result, index) => {
                        resultPreviews += `<div class="result-preview-mini" style="background-image: url('${result}');" onclick="viewImage('${result}'); event.stopPropagation();"></div>`;
                    });
                    if (task.results.length > 3) {
                        resultPreviews += `<div style="font-size: 12px; color: #999;">+${task.results.length - 3}</div>`;
                    }
                    resultPreviews += '</div>';
                } else {
                    resultPreviews = '<span style="color: #999; font-size: 12px;">æš‚æ— ç»“æœ</span>';
                }

                html += `
                    <div class="task-row" onclick="openTaskDetail('${task.id}')">
                        <div class="task-id">${task.id}</div>
                        <div><span class="task-status ${statusClass}">${statusText}</span></div>
                        <div class="task-model">${task.model}</div>
                        <div class="task-prompt-preview">${task.prompt.substring(0, 50)}...</div>
                        <div>${resultPreviews}</div>
                        <div class="task-time">${task.createdAt.split(' ')[1]}</div>
                        <div class="task-action">æŸ¥çœ‹è¯¦æƒ…</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // è¿‡æ»¤ä»»åŠ¡
        function filterTasks() {
            renderTaskList();
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            const total = filteredTasks.length;
            const completed = filteredTasks.filter(t => t.status === 'completed').length;
            const pending = filteredTasks.filter(t => t.status === 'pending').length;

            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('pendingTasks').textContent = pending;
        }

        // æ‰“å¼€ä»»åŠ¡è¯¦æƒ…
        function openTaskDetail(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const modal = document.getElementById('taskDetailModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');

            title.textContent = `${task.id} - ä»»åŠ¡è¯¦æƒ…`;

            const statusClass = task.status === 'completed' ? 'completed' : 
                               task.status === 'pending' ? 'pending' : 'failed';
            const statusText = task.status === 'completed' ? 'å·²å®Œæˆ' : 
                              task.status === 'pending' ? 'å¤„ç†ä¸­' : 'å¤±è´¥';

            let html = `
                <div class="detail-section">
                    <h3>åŸºæœ¬ä¿¡æ¯</h3>
                    <div class="detail-info-grid">
                        <div class="detail-info-item">
                            <div class="detail-info-label">ä»»åŠ¡ID</div>
                            <div class="detail-info-value">${task.id}</div>
                        </div>
                        <div class="detail-info-item">
                            <div class="detail-info-label">çŠ¶æ€</div>
                            <div class="detail-info-value"><span class="status-badge ${statusClass}">${statusText}</span></div>
                        </div>
                        <div class="detail-info-item">
                            <div class="detail-info-label">æ¨¡å‹</div>
                            <div class="detail-info-value">${task.model}</div>
                        </div>
                        <div class="detail-info-item">
                            <div class="detail-info-label">åˆ›å»ºæ—¶é—´</div>
                            <div class="detail-info-value">${task.createdAt}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>æç¤ºè¯</h3>
                    <div class="detail-info-item" style="padding: 12px;">
                        <div class="detail-info-value" style="white-space: pre-wrap; word-break: break-word;">${task.prompt}</div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>è¾“å…¥å›¾ç‰‡</h3>
                    <div class="detail-image-grid">
                        ${task.baseImage ? `
                            <div class="detail-image-item">
                                <img src="${task.baseImage}" onclick="viewImage('${task.baseImage}'); event.stopPropagation();">
                                <div class="detail-image-label">åŸºç¡€å›¾ç‰‡</div>
                            </div>
                        ` : ''}
                        ${task.referenceImage ? `
                            <div class="detail-image-item">
                                <img src="${task.referenceImage}" onclick="viewImage('${task.referenceImage}'); event.stopPropagation();">
                                <div class="detail-image-label">å‚è€ƒå›¾ç‰‡</div>
                            </div>
                        ` : ''}
                        ${task.refStyleImage ? `
                            <div class="detail-image-item">
                                <img src="${task.refStyleImage}" onclick="viewImage('${task.refStyleImage}'); event.stopPropagation();">
                                <div class="detail-image-label">é£æ ¼å‚è€ƒ</div>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <div class="detail-section">
                    <h3>ç”Ÿæˆç»“æœ</h3>
                    ${task.results && task.results.length > 0 ? `
                        <div class="result-grid">
                            ${task.results.map((result, index) => `
                                <div class="result-item" onclick="viewImage('${result}')">
                                    <div class="result-image has-image" style="background-image: url('${result}');">
                                        <div class="check-mark">âœ“</div>
                                    </div>
                                    <div class="result-prompt">ç»“æœ ${index + 1}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="no-results">
                            ${task.status === 'pending' ? 'ğŸ”„ ä»»åŠ¡å¤„ç†ä¸­...' : 
                              task.status === 'failed' ? `âŒ ç”Ÿæˆå¤±è´¥: ${task.errorMessage || 'æœªçŸ¥é”™è¯¯'}` : 
                              'æš‚æ— ç”Ÿæˆç»“æœ'}
                        </div>
                    `}
                </div>

                ${task.status === 'completed' ? `
                    <div class="edit-area">
                        <h4>âœï¸ é‡æ–°ç¼–è¾‘å¹¶æäº¤</h4>
                        <div class="form-group">
                            <label>ä¿®æ”¹æç¤ºè¯</label>
                            <textarea id="editPrompt">${task.prompt}</textarea>
                        </div>
                        <div class="edit-buttons">
                            <button class="btn" onclick="resubmitTask('${task.id}')">é‡æ–°ç”Ÿæˆ</button>
                        </div>
                    </div>
                ` : ''}
            `;

            body.innerHTML = html;
            modal.classList.add('active');
        }

        // å…³é—­ä»»åŠ¡è¯¦æƒ…
        function closeModal() {
            document.getElementById('taskDetailModal').classList.remove('active');
        }

        // æŸ¥çœ‹å¤§å›¾
        function viewImage(imageUrl) {
            const modal = document.getElementById('imagePreviewModal');
            const img = document.getElementById('imagePreviewImg');
            img.src = imageUrl;
            modal.classList.add('active');
        }

        // å…³é—­å¤§å›¾é¢„è§ˆ
        function closeImagePreview() {
            document.getElementById('imagePreviewModal').classList.remove('active');
        }

        // é‡æ–°æäº¤ä»»åŠ¡
        async function resubmitTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const newPrompt = document.getElementById('editPrompt').value.trim();
            if (!newPrompt) {
                alert('è¯·è¾“å…¥æç¤ºè¯');
                return;
            }

            const newTaskId = generateTaskId();
            const newTask = {
                ...task,
                id: newTaskId,
                prompt: newPrompt,
                status: 'pending',
                results: [],
                createdAt: getCurrentTime(),
                updatedAt: getCurrentTime()
            };

            tasks.unshift(newTask);
            saveData();
            closeModal();
            renderTaskList();

            try {
                let response;
                if (task.type === 'textToImage') {
                    response = await callAI_API(task.modelCode, newPrompt, task.referenceImage, null, null, task.count);
                } else {
                    response = await callAI_API(task.modelCode, newPrompt, null, task.baseImage, task.refStyleImage, task.count);
                }

                newTask.status = 'completed';
                newTask.results = response.images || [];
                newTask.updatedAt = getCurrentTime();
                
                saveData();
                renderTaskList();
                
                alert('å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼');
                openTaskDetail(newTaskId);

            } catch (error) {
                newTask.status = 'failed';
                newTask.errorMessage = error.message;
                newTask.updatedAt = getCurrentTime();
                
                saveData();
                renderTaskList();
                
                alert(`ç”Ÿæˆå¤±è´¥: ${error.message}`);
            }
        }
    </script>
</body>
</html>